name: Nightly Release

on:
  schedule:
    # Run at 2:00 AM UTC every day
    - cron: '0 2 * * *'
  workflow_dispatch:  # Allow manual trigger

env:
  CARGO_TERM_COLOR: always

jobs:
  build-linux:
    name: Build Linux Binary
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable

    - name: Cache cargo registry
      uses: actions/cache@v4
      with:
        path: ~/.cargo/registry
        key: linux-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          linux-cargo-registry-

    - name: Cache cargo index
      uses: actions/cache@v4
      with:
        path: ~/.cargo/git
        key: linux-cargo-git-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          linux-cargo-git-

    - name: Cache target directory
      uses: actions/cache@v4
      with:
        path: target
        key: linux-target-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          linux-target-

    - name: Run tests
      run: cargo test --verbose

    - name: Build release binary
      run: cargo build --release --verbose

    - name: Get current date
      id: date
      run: echo "date=$(date +'%Y%m%d')" >> $GITHUB_OUTPUT

    - name: Get commit short SHA
      id: commit
      run: echo "sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

    - name: Create tarball
      run: |
        mkdir -p release
        cp target/release/kmc release/
        cp README.md release/ 2>/dev/null || true
        cd release
        tar czf kmc-nightly-linux-x86_64.tar.gz kmc README.md 2>/dev/null || tar czf kmc-nightly-linux-x86_64.tar.gz kmc

    - name: Create or update nightly release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: nightly
        name: Nightly Build (${{ steps.date.outputs.date }})
        body: |
          Automated nightly build from commit ${{ steps.commit.outputs.sha }}
          
          Built on: ${{ steps.date.outputs.date }}
          Commit: ${{ github.sha }}
          
          ## Installation
          
          ```bash
          wget https://github.com/${{ github.repository }}/releases/download/nightly/kmc-nightly-linux-x86_64.tar.gz
          tar xzf kmc-nightly-linux-x86_64.tar.gz
          chmod +x kmc
          ./kmc --help
          ```
          
          **Note:** This is an automated nightly build and may be unstable.
        files: release/kmc-nightly-linux-x86_64.tar.gz
        prerelease: true
        draft: false
        fail_on_unmatched_files: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Clean up old nightly releases
      uses: dev-drprasad/delete-older-releases@v0.3.2
      with:
        keep_latest: 1
        delete_tag_pattern: nightly
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
